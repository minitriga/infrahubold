---
# yamllint disable rule:line-length
services:
  infrahub-test:
    build:
      context: ../
      dockerfile: development/Dockerfile
      target: backend
    image: "${IMAGE_NAME}:${IMAGE_VER}"
    environment:
      - "INFRAHUB_BUILD_NAME=${INFRAHUB_BUILD_NAME}"
      - "INFRAHUB_CONFIG=/source/development/infrahub.toml"
      - "INFRAHUB_PRODUCTION=false"
      - "INFRAHUB_LOG_LEVEL=CRITICAL"
      - "INFRAHUB_TEST_IN_DOCKER=1"
      - "INFRAHUB_DB_TYPE=${INFRAHUB_DB_TYPE}"
      - "INFRAHUB_BROKER_DRIVER=${INFRAHUB_BROKER_DRIVER:-rabbitmq}"
      - "INFRAHUB_BROKER_ADDRESS=${INFRAHUB_BROKER_ADDRESS:-message-queue}"
      - "INFRAHUB_BROKER_PORT=${INFRAHUB_BROKER_PORT:-5672}"
      - "INFRAHUB_BROKER_USERNAME=${INFRAHUB_BROKER_USERNAME:-infrahub}"
      - "INFRAHUB_BROKER_PASSWORD=${INFRAHUB_BROKER_PASSWORD:-infrahub}"
      - "INFRAHUB_CACHE_DRIVER=${INFRAHUB_CACHE_DRIVER:-redis}"
      - "INFRAHUB_CACHE_ADDRESS=${INFRAHUB_CACHE_ADDRESS:-cache}"
      - "INFRAHUB_CACHE_PORT=${INFRAHUB_CACHE_PORT:-6379}"
    volumes:
      - ../:/source
    tty: true
